name: Ahma MCP
permissions:
  contents: read
  pages: write
  id-token: write
# Heavy use of multi-layer caching to speed builds
# Github Actions caches grow since they do not forget unused files from old versions
#
# We rotate to a new cache every day, loading from the previous day's cache and
# then saving the fresh cache only containing the current files. We also work off of
# the 'main' banch. Github caching has special rules to fall back to 'main' from
# other branches. We also do not make new caches with every push to reduce clutter.
# There is an inherent performance tradeoff with this approach between slowly making
# new caches frequently (for example if we build new caches each time the git hash
# changes) and caches being too stupid to save updates if the name has not changed,
# thus forcing re-builds of any changes for the rest of the current day. Daily cache
# rotation is a good compromise.
#
# Caches still grow and slow things down. Run the following from command line if you
# want to delete caches, perhaps different types at different times:
#   gh cache delete --all
#   gh cache delete cargo-
#   gh cache delete sccache-
#   gh cache delete gradle-
#
# Avoid pull requests- they cause needless double builds. Instead rebase from 'main'
# to your branch to give priority to your changes. Then rebase from your branch back
# to 'main', test, then push.

#concurrency:
#  group: build # Only one build at a time, otherwise cache is not used effectively
#  cancel-in-progress: false

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main, production]

env:
  RUSTUP_MAX_RETRIES: 10
  CARGO_TERM_COLOR: always
  CARGO_PAGER: cat
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_TEST_DEBUG: 0
  CARGO_NET_RETRY: 10
  CARGO_PROFILE_DEV_BUILD_OVERRIDE_DEBUG: false
  RUSTFLAGS: -C debuginfo=0 # Do not produce debug symbols to keep memory usage down
  RUST_BACKTRACE: 1
  IS_DEV_BUILD: "true" # Set "true" to speed up builds for CI testing

jobs:
  job-cargo-build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Configure deterministic tooling env
        run: |
          git config --global core.pager cat
          echo "PAGER=cat" >> $GITHUB_ENV
          echo "LC_ALL=C" >> $GITHUB_ENV
          echo "LANG=C" >> $GITHUB_ENV

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache Cargo build artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
          key: cargo-build-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-build-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
          key: sccache-build-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-build-${{ runner.os }}-

      - name: Setup Cargo Binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            echo "cargo-audit not found, installing..."
            cargo binstall cargo-audit --no-confirm || cargo install cargo-audit
          else
            echo "cargo-audit is already installed"
          fi

      - name: Install cargo-edit
        run: |
          if ! command -v cargo-upgrade &> /dev/null; then
            echo "cargo-edit (cargo-upgrade) not found, installing..."
            cargo binstall cargo-edit --no-confirm || cargo install cargo-edit
          else
            echo "cargo-edit is already installed"
          fi

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - name: Cargo Build
        run: |
          cargo build --locked

      - name: Cargo Clippy
        run: cargo clippy --locked

      - name: Cargo Clippy Tests
        run: cargo clippy --tests --locked

      - name: Cargo Doc
        run: |
          cargo doc --no-deps

      - name: Upload documentation
        uses: actions/upload-artifact@v6
        with:
          name: documentation-${{ matrix.os }}
          path: target/doc

      #- name: Perform CodeQL Analysis
      #  uses: github/codeql-action/analyze@v3
      #  with:
      #    category: "/language:${{matrix.language}}"

      - name: Show sccache stats
        run: sccache --show-stats

  #######################################

  job-nextest:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Configure deterministic tooling env
        run: |
          git config --global core.pager cat
          echo "PAGER=cat" >> $GITHUB_ENV
          echo "LC_ALL=C" >> $GITHUB_ENV
          echo "LANG=C" >> $GITHUB_ENV

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache Cargo build artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
          key: cargo-nextest-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-nextest-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
          key: sccache-nextest-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-nextest-${{ runner.os }}-

      - name: Setup Cargo Binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            echo "cargo-audit not found, installing..."
            cargo binstall cargo-audit --no-confirm || cargo install cargo-audit
          else
            echo "cargo-audit is already installed"
          fi

      - name: Install cargo-edit
        run: |
          if ! command -v cargo-upgrade &> /dev/null; then
            echo "cargo-edit (cargo-upgrade) not found, installing..."
            cargo binstall cargo-edit --no-confirm || cargo install cargo-edit
          else
            echo "cargo-edit is already installed"
          fi

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Ensure cargo-nextest is installed (fallback)
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "cargo-nextest not found, installing..."
            cargo binstall cargo-nextest --no-confirm || cargo install cargo-nextest --locked
          else
            echo "cargo-nextest already installed"
          fi

      - name: Cargo Nextest (excluding Android/Gradle tests)
        run: |
          echo "--- cargo --version" && cargo --version
          echo "--- cargo --help (first 40 lines)" && cargo --help | head -n 40 || true
          echo "--- cargo --list (first 40 lines)" && cargo --list | head -n 40 || true
          # Exclude gradle/android tests - they run in job-android only
          # Use CI profile for longer timeouts and retry on flaky tests
          cargo nextest run --locked --no-default-features --profile ci -E 'not test(gradlew) & not test(android)'

      - name: Show sccache stats
        run: sccache --show-stats

  #######################################

  # Alternative test runner using cargo test instead of nextest
  # This job runs in parallel with job-nextest for comparison
  # Useful for diagnosing issues that may be specific to one test runner
  job-cargo-test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Configure deterministic tooling env
        run: |
          git config --global core.pager cat
          echo "PAGER=cat" >> $GITHUB_ENV
          echo "LC_ALL=C" >> $GITHUB_ENV
          echo "LANG=C" >> $GITHUB_ENV

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache Cargo build artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
          key: cargo-test-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-test-target-${{ runner.os }}-
            cargo-nextest-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
          key: sccache-test-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-test-${{ runner.os }}-
            sccache-nextest-${{ runner.os }}-

      - name: Setup Cargo Binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            echo "cargo-audit not found, installing..."
            cargo binstall cargo-audit --no-confirm || cargo install cargo-audit
          else
            echo "cargo-audit is already installed"
          fi

      - name: Install cargo-edit
        run: |
          if ! command -v cargo-upgrade &> /dev/null; then
            echo "cargo-edit (cargo-upgrade) not found, installing..."
            cargo binstall cargo-edit --no-confirm || cargo install cargo-edit
          else
            echo "cargo-edit is already installed"
          fi

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - name: Cargo Test (excluding Android/Gradle tests)
        run: |
          echo "--- cargo --version" && cargo --version
          echo "--- Running cargo test (standard test harness)"
          # Exclude gradle/android tests - they run in job-android only
          # Using --skip for pattern-based exclusion in standard test runner
          cargo test --locked --no-default-features -- --skip gradlew --skip android

      - name: Show sccache stats
        run: sccache --show-stats

  #######################################

  job-android:
    runs-on: macos-latest
    env:
      TERM: xterm-256color
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache AGP and more Gradle directories
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches/modules-2
            ~/.gradle/caches/jars-*
            ~/.gradle/caches/transforms-*
            ~/.gradle/caches/build-cache-*
            ~/.gradle/daemon
            ~/.gradle/wrapper
          key: gradle-deeper-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            gradle-deeper-${{ runner.os }}-

      - name: Preheat Gradle Daemon
        run: |
          ./gradlew tasks > /dev/null &
          echo "Gradle warming up slowly in background..."
        working-directory: ./test-data/AndoidTestBasicViews

      - uses: dtolnay/rust-toolchain@stable

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache Android Cargo build artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
          key: cargo-android-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-android-target-${{ runner.os }}-
            cargo-nextest-target-${{ runner.os }}-
            cargo-build-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
          key: sccache-android-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-android-${{ runner.os }}-
            sccache-nextest-${{ runner.os }}-
            sccache-build-${{ runner.os }}-

      - uses: cargo-bins/cargo-binstall@main

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - name: Check for cargo-ndk and install if missing
        run: |
          if ! command -v cargo-ndk &> /dev/null; then
            echo "cargo-ndk not found, installing..."
            cargo binstall cargo-ndk --no-confirm || cargo install cargo-ndk --locked
          else
            echo "cargo-ndk is already installed, skipping installation"
          fi
          cargo ndk --version

      - name: Cache Android build artifacts
        uses: actions/cache@v5
        with:
          path: |
            ${{ github.workspace }}/.gradle
            ${{ runner.tool_cache }}/gradle
            ./test-data/AndoidTestBasicViews/.gradle
            ./test-data/AndoidTestBasicViews/app/build/intermediates
            ./test-data/AndoidTestBasicViews/app/build/outputs
            ./test-data/AndoidTestBasicViews/app/build/kotlin
            ./test-data/AndoidTestBasicViews/app/build/generated
            ./test-data/AndoidTestBasicViews/app/build/kspCaches
            ./test-data/AndoidTestBasicViews/app/build/tmp
            ./test-data/AndoidTestBasicViews/build/kotlin
            ./test-data/AndoidTestBasicViews/build/intermediates
          key: gradle-android-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            gradle-android-${{ runner.os }}-


      - uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Ensure cargo-nextest is installed (fallback)
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "cargo-nextest not found, installing..."
            cargo binstall cargo-nextest --no-confirm || cargo install cargo-nextest --locked
          else
            echo "cargo-nextest already installed"
          fi

      - name: Run Android/Gradle tests only
        run: |
          # Run ONLY gradle/android tests (feature-gated and name-filtered for clarity)
          cargo nextest run --locked -p ahma_mcp --features android -E 'test(gradlew) | test(android)'

      - name: Show sccache stats
        run: sccache --show-stats

  #######################################

  job-coverage:
    runs-on: ubuntu-latest
    # Only run on main branch pushes, not pull requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Configure deterministic tooling env
        run: |
          git config --global core.pager cat
          echo "PAGER=cat" >> $GITHUB_ENV
          echo "LC_ALL=C" >> $GITHUB_ENV
          echo "LANG=C" >> $GITHUB_ENV

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache Cargo build artifacts
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
          key: cargo-coverage-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-coverage-target-${{ runner.os }}-
            cargo-nextest-target-${{ runner.os }}-
            cargo-build-target-${{ runner.os }}-

      - name: Cache AGP and more Gradle directories
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches/modules-2
            ~/.gradle/caches/jars-*
            ~/.gradle/caches/transforms-*
            ~/.gradle/caches/build-cache-*
            ~/.gradle/daemon
            ~/.gradle/wrapper
          key: gradle-deeper-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            gradle-deeper-${{ runner.os }}-

      - name: Preheat Gradle Daemon
        run: |
          ./gradlew tasks > /dev/null &
          echo "Gradle warming up slowly in background..."
        working-directory: ./test-data/AndoidTestBasicViews

      - name: Cache sccache artifacts
        uses: actions/cache@v5
        with:
          path: ~/.cache/sccache
          key: sccache-coverage-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-coverage-${{ runner.os }}-
            sccache-nextest-${{ runner.os }}-
            sccache-build-${{ runner.os }}-

      - name: Setup Cargo Binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - name: Check for cargo-ndk and install if missing
        run: |
          if ! command -v cargo-ndk &> /dev/null; then
            echo "cargo-ndk not found, installing..."
            cargo binstall cargo-ndk --no-confirm || cargo install cargo-ndk --locked
          else
            echo "cargo-ndk is already installed, skipping installation"
          fi
          cargo ndk --version

      - name: Install cargo-llvm-cov
        run: |
          if ! command -v cargo-llvm-cov &> /dev/null; then
            echo "cargo-llvm-cov not found, installing..."
            cargo binstall cargo-llvm-cov --no-confirm || cargo install cargo-llvm-cov --locked
          else
            echo "cargo-llvm-cov is already installed"
          fi

      - uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Ensure cargo-nextest is installed (fallback)
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "cargo-nextest not found, installing..."
            cargo binstall cargo-nextest --no-confirm || cargo install cargo-nextest --locked
          else
            echo "cargo-nextest already installed"
          fi

      - name: Install debtmap
        run: |
          if ! command -v debtmap &> /dev/null; then
             echo "debtmap not found, installing..."
             cargo binstall debtmap --no-confirm || cargo install debtmap --locked
          else
             echo "debtmap is already installed"
          fi

      - name: Generate coverage report
        run: |
          cargo llvm-cov nextest --profile coverage --locked --no-default-features --html --output-dir ./coverage

      - name: Generate debtmap report
        run: |
          debtmap analyze . --format markdown > ./coverage/debtmap.md

      - name: Generate code health report
        run: |
          cd scripts/metrics-aggregator
          cargo run -- ../.. --limit 20 --html
          cp ../../CODE_HEALTH_REPORT.md ../../coverage/
          cp ../../CODE_HEALTH_REPORT.html ../../coverage/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload coverage artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./coverage

      - name: Upload debtmap markdown artifact
        uses: actions/upload-artifact@v4
        with:
          name: debtmap-markdown
          path: ./coverage/debtmap.md

      - name: Upload code health report artifact
        uses: actions/upload-artifact@v4
        with:
          name: code-health-report
          path: ./coverage/CODE_HEALTH_REPORT.md

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Show sccache stats
        run: sccache --show-stats
