name: Ahma MCP
permissions:
  contents: read
# Heavy use of multi-layer caching to speed builds
# Github Actions caches grow since they do not forget unused files from old versions
#
# We rotate to a new cache every day, loading from the previous day's cache and
# then saving the fresh cache only containing the current files. We also work off of
# the 'main' banch. Github caching has special rules to fall back to 'main' from
# other branches. We also do not make new caches with every push to reduce clutter.
# There is an inherent performance tradeoff with this approach between slowly making
# new caches frequently (for example if we build new caches each time the git hash
# changes) and caches being too stupid to save updates if the name has not changed,
# thus forcing re-builds of any changes for the rest of the current day. Daily cache
# rotation is a good compromise.
#
# Caches still grow and slow things down. Run the following from command line if you
# want to delete caches, perhaps different types at different times:
#   gh cache delete --all
#   gh cache delete cargo-
#   gh cache delete sccache-
#   gh cache delete gradle-
#
# Avoid pull requests- they cause needless double builds. Instead rebase from 'main'
# to your branch to give priority to your changes. Then rebase from your branch back
# to 'main', test, then push.

concurrency:
  group: build # Only one build at a time, otherwise cache is not used effectively
  cancel-in-progress: false

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main, production]

env:
  RUSTUP_MAX_RETRIES: 10
  CARGO_TERM_COLOR: always
  CARGO_PAGER: cat
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_TEST_DEBUG: 0
  CARGO_NET_RETRY: 10
  CARGO_PROFILE_DEV_BUILD_OVERRIDE_DEBUG: false
  RUSTFLAGS: -C debuginfo=0 # Do not produce debug symbols to keep memory usage down
  RUST_BACKTRACE: 1
  IS_DEV_BUILD: "true" # Set "true" to speed up builds for CI testing

jobs:
  job-cargo-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        language: ["rust"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Configure deterministic tooling env
        run: |
          git config --global core.pager cat
          echo "PAGER=cat" >> $GITHUB_ENV
          echo "LC_ALL=C" >> $GITHUB_ENV
          echo "LANG=C" >> $GITHUB_ENV

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache Cargo build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
            ./target
          key: cargo-build-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-build-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: sccache-build-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-build-${{ runner.os }}-

      - name: Setup Cargo Binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - name: Cargo Build
        run: |
          cargo build --locked

      - name: Cargo Clippy
        run: cargo clippy --locked

      - name: Cargo Clippy Tests
        run: cargo clippy --tests --locked

      - name: Cargo Doc
        run: |
          cargo doc --no-deps

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc

      #- name: Perform CodeQL Analysis
      #  uses: github/codeql-action/analyze@v3
      #  with:
      #    category: "/language:${{matrix.language}}"

      - name: Show sccache stats
        run: sccache --show-stats

  #######################################

  job-nextest:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        language: ["rust"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Configure deterministic tooling env
        run: |
          git config --global core.pager cat
          echo "PAGER=cat" >> $GITHUB_ENV
          echo "LC_ALL=C" >> $GITHUB_ENV
          echo "LANG=C" >> $GITHUB_ENV

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache Cargo build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
            ./target
          key: cargo-nextest-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-nextest-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: sccache-nextest-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-nextest-${{ runner.os }}-

      - name: Setup Cargo Binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - uses: taiki-e/install-action@nextest

      - name: Ensure cargo-nextest is installed (fallback)
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "cargo-nextest not found, installing..."
            cargo binstall cargo-nextest --no-confirm || cargo install cargo-nextest --locked
          else
            echo "cargo-nextest already installed"
          fi

      - name: Cargo Nextest (without Android tests)
        run: |
          echo "--- cargo --version" && cargo --version
          echo "--- cargo --help (first 40 lines)" && cargo --help | head -n 40 || true
          echo "--- cargo --list (first 40 lines)" && cargo --list | head -n 40 || true
          cargo nextest run --locked --no-default-features

      - name: Show sccache stats
        run: sccache --show-stats

  #######################################

  job-android:
    runs-on: macos-latest
    env:
      TERM: xterm-256color
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Get current day number
        id: day-number
        run: echo "day=$(date +%j)" >> $GITHUB_OUTPUT

      - name: Cache AGP and more Gradle directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/modules-2
            ~/.gradle/caches/jars-*
            ~/.gradle/caches/transforms-*
            ~/.gradle/caches/build-cache-*
            ~/.gradle/daemon
            ~/.gradle/wrapper
          key: gradle-deeper-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            gradle-deeper-${{ runner.os }}-

      - name: Cache Gradle Kotlin DSL
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches/kotlin-dsl
          key: kotlin-dsl-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            kotlin-dsl-${{ runner.os }}-

      - name: Preheat Gradle Daemon
        run: |
          ./gradlew tasks > /dev/null &
          echo "Gradle warming up slowly in background..."
        working-directory: ./test-data/AndoidTestBasicViews

      - uses: dtolnay/rust-toolchain@stable

      - name: Add Cargo Bin to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache Android Cargo build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/.package-cache
            ~/.cargo/bin
            ./target
          key: cargo-android-target-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            cargo-android-target-${{ runner.os }}-

      - name: Cache sccache artifacts
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Mozilla.sccache
          key: sccache-android-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            sccache-android-${{ runner.os }}-

      - uses: cargo-bins/cargo-binstall@main

      - name: Install sccache
        run: |
          if ! command -v sccache &> /dev/null; then
            echo "sccache not found, installing..."
            cargo binstall sccache --no-confirm || cargo install sccache
          else
            echo "sccache is already installed"
          fi
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          sccache --show-stats

      - name: Check for cargo-ndk and install if missing
        run: |
          if ! command -v cargo-ndk &> /dev/null; then
            echo "cargo-ndk not found, installing..."
            cargo binstall cargo-ndk --no-confirm || cargo install cargo-ndk --locked
          else
            echo "cargo-ndk is already installed, skipping installation"
          fi
          cargo ndk --version

      - name: Cache Android build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.gradle
            ${{ runner.tool_cache }}/gradle
            ./test-data/AndoidTestBasicViews/.gradle
            ./test-data/AndoidTestBasicViews/app/build/intermediates
            ./test-data/AndoidTestBasicViews/app/build/outputs
            ./test-data/AndoidTestBasicViews/app/build/kotlin
            ./test-data/AndoidTestBasicViews/app/build/generated
            ./test-data/AndoidTestBasicViews/app/build/kspCaches
            ./test-data/AndoidTestBasicViews/app/build/tmp
            ./test-data/AndoidTestBasicViews/build/kotlin
            ./test-data/AndoidTestBasicViews/build/intermediates
          key: gradle-android-${{ runner.os }}-day${{ steps.day-number.outputs.day }}
          restore-keys: |
            gradle-android-${{ runner.os }}-

      - name: Android Assemble Debug
        run: ./gradlew assembleDebug --parallel --daemon --configure-on-demand --build-cache --configuration-cache
        working-directory: ./test-data/AndoidTestBasicViews

      - name: Android Test
        run: ./gradlew test --rerun-tasks --parallel --daemon --configure-on-demand --no-configuration-cache
        working-directory: ./test-data/AndoidTestBasicViews

      - uses: taiki-e/install-action@nextest

      - name: Ensure cargo-nextest is installed (fallback)
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "cargo-nextest not found, installing..."
            cargo binstall cargo-nextest --no-confirm || cargo install cargo-nextest --locked
          else
            echo "cargo-nextest already installed"
          fi

      - name: Run macOS-only gradlew integration test
        run: cargo nextest run --locked -p ahma_core gradlew_interactive_test::test_gradlew_working_directory_handling

      - name: Show sccache stats
        run: sccache --show-stats
